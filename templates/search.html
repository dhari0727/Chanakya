{% extends "base.html" %}

{% block title %}{{ query }} - Google Search{% endblock %}
{% block content %}
<div class="search-page">
    <!-- Header with search bar -->
    <header class="site-header">
  <div class="header-container">

    <!-- Logo + Brand inline -->
    <div class="d-flex align-items-center mb-3">
      <img src="{{ url_for('static', filename='images/chanakya-logo-glow.png') }}" 
           alt="Chanakya Logo" 
           class="me-2" 
           style="width: 50px; height: 50px; object-fit: contain;">

      <a href="{{ url_for('index') }}" class="chanakya-logo text-decoration-none">
        Chanakya
      </a>
    </div>

    <!-- Search Form -->
    <form action="{{ url_for('search') }}" method="GET" class="search-form-header">
      <div class="search-container-header position-relative">
        <div class="search-input-wrapper-header">
          <input type="text" 
                 name="q" 
                 value="{{ query }}" 
                 class="search-input-header" 
                 autocomplete="off"
                 id="search-box"
                 placeholder="Search with wisdom...">
          <button type="submit" class="search-btn-header">
            <i class="fas fa-search"></i>
          </button>
        </div>

        <!-- Suggestions Dropdown -->
        <div class="suggestions-dropdown" id="suggestions">
          <ul class="suggestions-list"></ul>
        </div>
      </div>
    </form>

  </div>
</header>

<!-- Search Navigation Tabs -->
<nav class="chanakya-nav">
    <div class="nav-tabs-container">

        <a href="{{ url_for('search', q=query) }}" 
           class="nav-tab {% if tab == 'search' %}active{% endif %}">
            All
        </a>

        <a href="{{ url_for('search_images', q=query) }}" 
           class="nav-tab {% if tab == 'images' %}active{% endif %}">
            Images
        </a>

        <a href="{{ url_for('search_videos', q=query) }}" 
           class="nav-tab {% if tab == 'videos' %}active{% endif %}">
            Videos
        </a>

        <a href="{{ url_for('search_news', q=query) }}" 
           class="nav-tab {% if tab == 'news' %}active{% endif %}">
            News
        </a>

       

    </div>
</nav>
<!-- Verified Only Toggle -->
<form method="GET" action="{{ url_for('search') }}" class="verified-toggle">
  <input type="hidden" name="q" value="{{ query }}">
  
  <label class="switch">
    <input type="checkbox" id="verified" name="verified" value="true"
           {% if verified_only %}checked{% endif %}
           onchange="this.form.submit()">
    <span class="slider"></span>
  </label>
  
  <span class="toggle-text">Show verified sites only</span>
</form>

<!-- Search Results -->
<main class="search-results">
    <div class="container-fluid">
        <div class="results-info">
            About {{ "{:,}".format(total_results) if total_results else 0 }} results ({{ search_time }} seconds)
        </div>

        <!-- Direct Answer Box -->
        {% if direct_answer %}
        <div class="answer-box">
            <div class="answer-content">
                {{ direct_answer.answer }}
            </div>
            {% if direct_answer.sources %}
            <div class="answer-sources">
                {% for source in direct_answer.sources[:2] %}
                <a href="{{ url_for('out', url=source, q=query) }}" target="_blank" rel="noopener noreferrer" class="source-link">
                    {{ source.replace('https://', '').replace('http://', '').replace('www.', '') | truncate(50) }}
                </a>
                {% if not loop.last %} • {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endif %}

        {% if results %}
            {% if tab == "images" %}
                <!-- Image Grid -->
                <div class="image-grid">
                    {% for result in results %}
                        <a href="{{ url_for('out', url=result.url, q=query) }}" target="_blank" rel="noopener noreferrer" class="image-card">
                            <img src="{{ result.thumbnail }}" alt="{{ result.title }}">
                            <p>{{ result.title }}</p>
                        </a>
                    {% endfor %}
                </div>

            {% elif tab == "videos" %}
                <!-- Video Grid -->
                <div class="video-grid">
                    {% for result in results %}
                        <a href="{{ url_for('out', url=result.url, q=query) }}" target="_blank" rel="noopener noreferrer" class="video-card">
                            <img src="{{ result.thumbnail }}" alt="{{ result.title }}">
                            <p>{{ result.title }}</p>
                        </a>
                    {% endfor %}
                </div>

            {% elif tab == "news" %}
                <!-- News Results -->
                {% for result in results %}
                <div class="search-result position-relative">
                {% if result.verified %}
                    <span class="verified-badge" title="Verified site">✔</span>
                {% endif %}
                
                <div class="result-url d-flex align-items-center">
                    <span class="result-domain">{{ result.domain or result.source }}</span>
                    <i class="fas fa-chevron-down breadcrumb-arrow"></i>
                </div>
                <h3 class="result-title">
                    <a href="{{ url_for('out', url=result.url, q=query) }}" target="_blank" rel="noopener noreferrer">{{ result.title }}</a>
                </h3>
                <p class="result-snippet">{{ result.snippet }}</p>
            </div>
                {% endfor %}

            {% elif tab == "shopping" %}
                <!-- Shopping Results -->
                <div class="shopping-grid">
                    {% for result in results %}
                        <a href="{{ url_for('out', url=result.url, q=query) }}" target="_blank" rel="noopener noreferrer" class="shopping-card">
                            <img src="{{ result.thumbnail }}" alt="{{ result.title }}">
                            <h4>{{ result.title }}</h4>
                            <p class="price">{{ result.price }}</p>
                            {% if result.verified %}
                                <span class="verified-badge" title="Verified seller">✔</span>
                            {% endif %}
                        </a>
                    {% endfor %}
                </div>

            {% else %}
                <!-- Default: All/Text Results -->
                {% for result in results %}
                <div class="search-result">
                    <div class="result-url">
                        <span class="result-domain">{{ result.domain }}</span>
                        {% if result.verified %}
                            <span class="verified-badge" title="Verified site">✔</span>
                        {% endif %}
                        <i class="fas fa-chevron-down breadcrumb-arrow"></i>
                    </div>
                    <h3 class="result-title">
                        <a href="{{ url_for('out', url=result.url, q=query) }}" target="_blank" rel="noopener noreferrer">{{ result.title }}</a>
                    </h3>
                    <p class="result-snippet">{{ result.snippet }}</p>
                </div>
                {% endfor %}
            {% endif %}
            <!-- Pagination -->
            {% if total_pages > 1 %}
            <nav class="pagination-nav">
                <div class="pagination-container">
                    {% if page > 1 %}
                    <a href="{{ url_for('search', q=query, page=page-1, verified='true' if verified_only else None) }}" class="pagination-link">
                        <i class="fas fa-chevron-left"></i> Previous
                    </a>
                    {% endif %}

                    <div class="pagination-numbers">
                        {% for p in range(1, total_pages + 1) %}
                            {% if p == page %}
                                <span class="pagination-current">{{ p }}</span>
                            {% elif p <= 10 %}
                                <a href="{{ url_for('search', q=query, page=p, verified='true' if verified_only else None) }}" class="pagination-number">{{ p }}</a>
                            {% endif %}
                        {% endfor %}
                    </div>

                    {% if page < total_pages %}
                    <a href="{{ url_for('search', q=query, page=page+1, verified='true' if verified_only else None) }}" class="pagination-link">
                        Next <i class="fas fa-chevron-right"></i>
                    </a>
                    {% endif %}
                </div>
            </nav>
            {% endif %}
        {% else %}
            <div class="no-results">
                <p>Your search - <strong>{{ query }}</strong> - did not match any documents.</p>
                <p>Suggestions:</p>
                <ul>
                    <li>Make sure all words are spelled correctly.</li>
                    <li>Try different keywords.</li>
                    <li>Try more general keywords.</li>
                    <li>Try fewer keywords.</li>
                </ul>
            </div>
        {% endif %}
    </div>
</main>

    <!-- Footer -->
    <footer class="search-footer">
        <div class="container-fluid">
            <div class="footer-links">
                <div class="footer-left">
                    <a href="#" class="footer-link">Help</a>
                    <a href="#" class="footer-link">Send feedback</a>
                    <a href="#" class="footer-link">Privacy</a>
                    <a href="#" class="footer-link">Terms</a>
                </div>
            </div>
        </div>
    </footer>
</div>
{% endblock %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const input = document.getElementById("search-input-header");
  const dropdown = document.getElementById("suggestions-dropdown-header");
  const list = document.getElementById("suggestions-list-header");

  input.addEventListener("input", async function() {
    const q = input.value.trim();
    if (!q) {
      dropdown.style.display = "none";
      return;
    }
    try {
      const resp = await fetch(`/api/suggestions?q=${encodeURIComponent(q)}`);
      const suggestions = await resp.json();
      list.innerHTML = "";
      if (suggestions.length > 0) {
        suggestions.forEach(s => {
          const li = document.createElement("li");
          li.textContent = s;
          li.addEventListener("click", () => {
            input.value = s;
            dropdown.style.display = "none";
          });
          list.appendChild(li);
        });
        dropdown.style.display = "block";
      } else {
        dropdown.style.display = "none";
      }
    } catch (err) {
      console.error("Suggestions error:", err);
      dropdown.style.display = "none";
    }
  });

  // Hide on blur
  input.addEventListener("blur", () => {
    setTimeout(() => dropdown.style.display = "none", 200);
  });
});

</script>
